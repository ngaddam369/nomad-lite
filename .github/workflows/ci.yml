name: CI

on:
  push:
  pull_request:
    branches: [master, main]

env:
  CARGO_TERM_COLOR: always

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/rust-setup
        with:
          components: rustfmt
          skip-protobuf: 'true'

      - name: Check formatting
        run: cargo fmt --check

  clippy:
    needs: format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/rust-setup
        with:
          components: clippy

      - name: Run clippy
        run: cargo clippy -- -D warnings

  build:
    needs: clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/rust-setup

      - name: Build
        run: cargo build --verbose

  test:
    name: test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/rust-setup

      - name: Run unit tests
        run: |
          cargo test --lib --verbose
          cargo test --test raft_rpc_tests --verbose
          cargo test --test scheduler_tests --verbose
          cargo test --test dashboard_tests --verbose
          cargo test --test internal_service_tests --verbose
          cargo test --test executor_tests --verbose

      - name: Run integration tests
        run: cargo test --test integration_tests --verbose -- --test-threads=1

      - name: Run failover tests
        run: cargo test --test failover_tests --verbose -- --test-threads=1

      - name: Run partition tests
        run: cargo test --test partition_tests --verbose -- --test-threads=1

      - name: Run chaos/fault injection tests
        run: cargo test --test chaos_tests --verbose -- --test-threads=1

      - name: Run leadership transfer tests
        run: cargo test --test leadership_transfer_tests --verbose -- --test-threads=1

      - name: Run drain tests
        run: cargo test --test drain_tests --verbose -- --test-threads=1

      - name: Verify openssl is available (required for cert generation)
        run: openssl version

      - name: Make cert generation script executable
        run: chmod +x ./scripts/gen-test-certs.sh

      - name: Verify cert generation script works
        run: |
          ./scripts/gen-test-certs.sh /tmp/test-certs
          ls -la /tmp/test-certs
          rm -rf /tmp/test-certs

      - name: Run TLS/mTLS authentication tests
        run: cargo test --test tls_tests --verbose

  coverage:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/rust-setup

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage report
        # Only run unit tests and stable test binaries for coverage.
        # Integration/partition/failover/chaos tests use tight Raft election
        # timeouts that become flaky under tarpaulin's instrumentation overhead.
        run: >
          cargo tarpaulin --out xml --skip-clean
          --lib
          --test raft_rpc_tests
          --test scheduler_tests
          --test dashboard_tests
          --test internal_service_tests
          --test executor_tests
          --test tls_tests

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: cobertura.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
